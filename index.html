<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>å°å¹´çœ‹é†«ç”Ÿ</title>

  <!-- iOS ä¸»ç•«é¢æ›¸ç±¤ icon -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="å°å¹´çœ‹é†«ç”Ÿ" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --main: #7A9078;         /* æŠ¹èŒ¶ç¶  */
      --main-dark: #4F6350;
      --bg: #F9F9F7;           /* æš–ç±³ç™½ */
      --text: #5A5A5A;
      --weekend: #D68C8C;
      --today-border: #AABEA8;
      
      --light-green: #E8F3E8;
      --text-green: #5C8D5C;
      --light-yellow: #FEF8E0;
      --text-yellow: #B89C3A;
      --light-red: #F9EBEB;
      --text-red: #CD7F7F;
    }

    html, body { height: 100%; background: var(--bg); color: var(--text); overflow: hidden; }
    body{
      font-family:'Noto Sans TC', system-ui, -apple-system, sans-serif;
      -webkit-tap-highlight-color: transparent;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      overscroll-behavior-y: none;
    }

    /* âœ… FIX #1ï¼šPWA ä¸»ç•«é¢æ¨¡å¼é¿å…åº•éƒ¨è¢«è£æ‰ï¼ˆä¸é–‹å•Ÿæ•´é æ»¾å‹•ï¼‰ */
    #app{
      height: calc(100svh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* æ—¥æ›†å¤–æ®¼ */
    .calendar-shell{
      display:flex;
      flex-direction:column;
      flex: 0 0 auto; /* âœ… ä¸è¦ç¡¬åƒæ»¿æ•´å€‹å‰©é¤˜é«˜åº¦ï¼Œé¿å…æŠŠä¸‹é¢æ“ æ‰ */
      min-height: 0;
      border-radius: 1.8rem;
      background: rgba(255,255,255,0.8);
      border: 1px solid rgba(255,255,255,0.9);
      box-shadow: 0 4px 12px rgba(0,0,0,0.02);
    }

    .cal-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      padding: 12px 14px 8px;
    }

    .weekday-cell {
      text-align: center;
      font-size: 12px;
      font-weight: 900;
      width: 100%;
    }

    .days-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 6px;
      padding: 0 14px 14px;

      /* âœ… FIX #1ï¼šç¸®çŸ­æ—¥æ›†é«˜åº¦ï¼Œè®“åº•ä¸‹æ¸…å–®ä¸è¢«æ“ æ‰ */
      height: clamp(250px, 38svh, 330px);
    }

    .day-cell{
      width: 100%; height: 100%;
      border-radius: 14px;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      position: relative;
    }

    .today-ring{ border: 2px solid var(--today-border); }

    .modal-sheet{
      max-height: 90svh;
      overflow-y:auto;
      border-top-left-radius: 2rem;
      border-top-right-radius: 2rem;
    }

    /* éš±è—æ»¾å‹•æ¢ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    @keyframes popIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .animate-pop-in { animation: popIn 0.2s ease-out; }
  </style>
</head>

<body>
  <div id="app" class="max-w-md mx-auto px-5"></div>

  <script>
    const KEY_TITLE = "med_app_title_v3";
    const KEY_DATA  = "med_record_data_v3";

    /* âœ… FIX #3ï¼šå¸¸ç”¨æ¨™ç±¤å¯ç®¡ç†ã€å¯è¨˜æ†¶ */
    const KEY_TAGS  = "med_preset_tags_v3";
    const PRESET_TAGS = ["é†«å¸«ç´°å¿ƒ", "è§£é‡‹æ¸…æ¥š", "è­·ç†å¸«æº«æŸ”", "ç­‰å¾ˆä¹…", "ç’°å¢ƒèˆ’é©", "æ…‹åº¦å·®", "æ›è™Ÿé›£", "è—¥æ•ˆå¿«", "åœè»Šæ–¹ä¾¿", "è‡ªè²»é …ç›®"];
    function loadTags(){
      try{
        const t = JSON.parse(localStorage.getItem(KEY_TAGS) || "null");
        return Array.isArray(t) && t.length ? t : [...PRESET_TAGS];
      }catch(e){
        return [...PRESET_TAGS];
      }
    }
    function saveTags(tags){
      localStorage.setItem(KEY_TAGS, JSON.stringify(tags));
      state.tags = tags;
    }

    const today = new Date();
    let state = {
      currentDate: new Date(today.getFullYear(), today.getMonth(), 1),
      selectedDate: null,
      appTitle: localStorage.getItem(KEY_TITLE) || "å°å¹´çœ‹é†«ç”Ÿ",
      isEditingTitle: false,
      records: JSON.parse(localStorage.getItem(KEY_DATA) || "{}"),
      tags: loadTags()
    };

    function saveData(){ localStorage.setItem(KEY_DATA, JSON.stringify(state.records)); }
    function saveTitle(t){ state.appTitle = t; localStorage.setItem(KEY_TITLE, t); }
    function formatDateKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function parseDateKey(key){
      const [y,m,d] = key.split("-").map(Number);
      return new Date(y, m-1, d);
    }
    function formatMD(key){
      const dt = parseDateKey(key);
      return `${dt.getMonth()+1}/${dt.getDate()}`;
    }

    /********************
     * Statistics Logic
     ********************/
    function calculateStats(){
      const y = state.currentDate.getFullYear();
      const m = state.currentDate.getMonth();

      let yTotal=0, yCount=0, mTotal=0, mCount=0;
      const comboFreq = {}; 
      const goodSet = new Set(); 
      const badSet = new Set();
      const goodData = []; 
      const badData = [];

      Object.keys(state.records).forEach(key => {
        const dt = parseDateKey(key);
        const isYear = dt.getFullYear() === y;
        const isMonth = isYear && dt.getMonth() === m;

        (state.records[key]||[]).forEach(rec => {
           const price = Number(rec.price || 0);
           if(isYear){ yTotal += price; yCount++; }
           if(isMonth){ mTotal += price; mCount++; }
           
           const hosp = (rec.hospital||"").trim() || "æœªå¡«é™¢æ‰€";
           const it   = (rec.item||"").trim() || "ä¸€èˆ¬çœ‹è¨º";
           const dr   = (rec.doctor||"").trim() || "æœªå¡«é†«å¸«";

           // çµ±è¨ˆæœ€å¸¸å»çµ„åˆ
           const comboKey = `${hosp}||${dr}||${it}`;
           comboFreq[comboKey] = (comboFreq[comboKey]||0)+1;

           // âœ… FIX #2ï¼šæ¸…å–®è¦èƒ½ä¿ç•™ã€ŒåŒé™¢æ‰€/é†«å¸«ã€å¤šå€‹æ—¥æœŸï¼Œæ‰€ä»¥è³‡æ–™è¦æ¯ç­†éƒ½é€² goodData/badData
           const entityKey = `${hosp}||${dr}`;
           if(rec.rating === "good"){
             goodSet.add(entityKey);
             goodData.push({rec, date: key});
           }
           if(rec.rating === "bad"){
             badSet.add(entityKey);
             badData.push({rec, date: key});
           }
        });
      });

      const topCombos = Object.entries(comboFreq)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,3)
        .map(([k, v]) => {
           const [h, d, i] = k.split("||");
           return { hospital: h, doctor: d, item: i };
        });

      while(topCombos.length < 3) topCombos.push({ hospital: "â€”", doctor: "â€”", item: "â€”" });

      return { 
        yTotal, yCount, mTotal, mCount, 
        topCombos, 
        goodCount: goodSet.size, 
        badCount: badSet.size,
        goodData, badData
      };
    }

    /********************
     * Render
     ********************/
    function render(){
      const app = document.getElementById("app");
      const stats = calculateStats();
      const year = state.currentDate.getFullYear();
      const month = state.currentDate.getMonth();
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const firstDay = new Date(year, month, 1).getDay();

      let titleHtml = state.isEditingTitle ? `
          <input id="titleInput" type="text" class="text-xl font-black text-[var(--main-dark)] text-center bg-white rounded-full px-4 py-2 border-2 border-[var(--main)] w-full max-w-[280px] outline-none" value="${state.appTitle}" />
        ` : `
          <div id="titleDisplay" class="flex items-center gap-2 cursor-pointer active:opacity-60 py-5">
            <h1 class="text-xl font-black tracking-widest text-[var(--main-dark)]">${state.appTitle}</h1>
            <svg class="opacity-30" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </div>
        `;

      const cells = [];
      for(let i=0;i<firstDay;i++) cells.push(null);
      for(let d=1; d<=daysInMonth; d++) cells.push(new Date(year, month, d));
      while(cells.length < 42) cells.push(null);

      let calendarCells = "";
      cells.forEach((dateObj, idx) => {
        if(!dateObj){ calendarCells += `<div class="day-cell"></div>`; return; }
        const key = formatDateKey(dateObj);
        const list = state.records[key] || [];
        const count = list.length;
        const isToday = (formatDateKey(today) === key);
        const isWeekend = (idx % 7 === 0) || (idx % 7 === 6);

        let bgClass = "bg-white/40", textClass = isWeekend ? 'text-[var(--weekend)]' : 'text-[var(--text)]';
        if(count === 1) { bgClass = "bg-[var(--light-green)]"; textClass = "text-[var(--text-green)]"; }
        else if(count === 2) { bgClass = "bg-[var(--light-yellow)]"; textClass = "text-[var(--text-yellow)]"; }
        else if(count >= 3) { bgClass = "bg-[var(--light-red)]"; textClass = "text-[var(--text-red)]"; }

        const daySum = list.reduce((s,i)=>s+Number(i.price||0),0);
        calendarCells += `
          <button onclick="openEditModal(${dateObj.getDate()})" class="day-cell ${bgClass} ${isToday ? "today-ring" : ""} active:scale-95 transition-transform">
            <span class="text-[12px] font-black ${textClass}">${dateObj.getDate()}</span>
            ${count>0 ? `<span class="text-[9px] font-bold opacity-60 ${textClass}">$${daySum}</span>` : ``}
          </button>
        `;
      });

      app.innerHTML = `
        <div class="flex justify-center shrink-0">${titleHtml}</div>

        <div class="grid grid-cols-2 gap-3 mb-4 shrink-0">
          <div class="bg-white/70 p-3 rounded-[1.2rem] shadow-sm text-center">
             <p class="text-[10px] font-black text-[#D68C8C] mb-1 tracking-widest">å¹´åº¦ç´¯è¨ˆ</p>
             <p class="text-sm font-black text-[var(--text)]">${stats.yCount} <span class="text-[10px] text-gray-400">æ¬¡</span> <span class="text-[#D68C8C] ml-1">$${stats.yTotal.toLocaleString()}</span></p>
          </div>
          <div class="bg-white/70 p-3 rounded-[1.2rem] shadow-sm text-center">
             <p class="text-[10px] font-black text-[var(--main)] mb-1 tracking-widest">æœ¬æœˆçµ±è¨ˆ</p>
             <p class="text-sm font-black text-[var(--text)]">${stats.mCount} <span class="text-[10px] text-gray-400">æ¬¡</span> <span class="text-[var(--main-dark)] ml-1">$${stats.mTotal.toLocaleString()}</span></p>
          </div>
        </div>

        <div class="flex items-center justify-between mb-4 shrink-0">
          <div class="flex items-center bg-white/60 p-1 rounded-full border border-white/50 shadow-sm gap-1">
            <div class="flex items-center px-2 gap-2">
              <button onclick="changeMonth(-1)" class="p-1 text-[var(--main-dark)] font-black">ã€ˆ</button>
              <span class="font-black text-sm text-[var(--main-dark)] min-w-[65px] text-center">${year}.${String(month+1).padStart(2,'0')}</span>
              <button onclick="changeMonth(1)" class="p-1 text-[var(--main-dark)] font-black">ã€‰</button>
            </div>
            <div class="h-4 w-[1px] bg-slate-200"></div>
            <button onclick="goToday()" class="px-4 py-1.5 text-xs font-black text-[var(--main-dark)] active:opacity-50">ä»Šå¤©</button>
          </div>
          <button onclick="quickAdd()" class="w-10 h-10 rounded-full bg-[var(--main)] text-white shadow-md flex items-center justify-center active:scale-90 transition-transform">
             <span class="text-xl font-black">ï¼‹</span>
          </button>
        </div>

        <div class="calendar-shell mb-4 shrink-0">
          <div class="cal-grid">
            ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map((d,i)=>`<div class="weekday-cell" style="color:${(i===0||i===6)?'var(--weekend)':'#B0B0B0'}">${d}</div>`).join('')}
          </div>
          <div class="days-grid">${calendarCells}</div>
        </div>

        <div class="shrink-0 space-y-3 pb-6">
           <!-- TOP Card (Modified) -->
           <button onclick="openTopModal()" class="w-full bg-white/70 px-4 py-3 rounded-[1.5rem] border border-white shadow-sm relative active:opacity-90">
              <div class="absolute left-1/2 -translate-x-1/2 -top-2 px-4 py-0.5 rounded-full bg-[var(--main)] text-white font-black text-[10px] tracking-wider">æˆ‘æœ€å¸¸å»</div>
              <div class="grid grid-cols-3 gap-2 pt-2 h-10">
                 ${stats.topCombos.map((c, i) => `
                    <div class="flex flex-col items-center justify-center overflow-hidden">
                       <!-- âœ… é€™å±¤åªé¡¯ç¤ºé™¢æ‰€åç¨± -->
                       <div class="text-[10px] font-black text-[var(--main-dark)] truncate w-full text-center">
                        ${c.hospital !== 'â€”' ? `${c.hospital}` : 'â€”'}
                       </div>
                       <!-- âœ… é€™å±¤é¡¯ç¤ºçœ‹è¨ºé …ç›® -->
                       <div class="text-[8px] font-bold text-slate-400 truncate w-full text-center mt-0.5">${c.item}</div>
                    </div>
                 `).join('')}
              </div>
           </button>

           <div class="grid grid-cols-2 gap-3">
              <button onclick="openListModal('good')" class="bg-white/70 py-4 rounded-[1.2rem] border border-white flex items-center justify-center gap-2 shadow-sm active:scale-95 text-[var(--main-dark)] transition-transform">
                 ${thumbIcon("var(--main-dark)")}
                 <span class="text-xs font-black">è®šè®šæ¸…å–® (${stats.goodCount})</span>
              </button>
              <button onclick="openListModal('bad')" class="bg-white/70 py-4 rounded-[1.2rem] border border-white flex items-center justify-center gap-2 shadow-sm active:scale-95 text-[#D68C8C] transition-transform">
                 ${thumbDownIcon("#D68C8C")}
                 <span class="text-xs font-black">è¸©é›·ç´€éŒ„ (${stats.badCount})</span>
              </button>
           </div>
        </div>
      `;

      if(state.isEditingTitle){
        const inp = document.getElementById("titleInput");
        inp.focus();
        inp.onblur = () => { if(inp.value.trim()) saveTitle(inp.value.trim()); state.isEditingTitle = false; render(); }
      } else {
        document.getElementById("titleDisplay").onclick = () => { state.isEditingTitle = true; render(); };
      }
    }

    /********************
     * Modal Operations
     ********************/
    function openEditModal(day){
      state.selectedDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day);
      renderModal();
    }

    function renderModal(){
      const dateKey = formatDateKey(state.selectedDate);
      const list = state.records[dateKey] || [];
      let modal = document.getElementById("editModal") || document.createElement("div");
      modal.id = "editModal";
      modal.className = "fixed inset-0 bg-black/20 backdrop-blur-sm z-[100] flex items-end";
      document.body.appendChild(modal);

      modal.innerHTML = `
        <div class="modal-sheet bg-[#F9F9F7] w-full p-6 pb-10 shadow-2xl relative flex flex-col h-auto max-h-[90vh]">
          <div class="flex justify-between items-center mb-5 shrink-0">
             <div class="flex flex-col">
               <h3 class="text-2xl font-black text-[var(--main-dark)]">${state.selectedDate.getMonth()+1}æœˆ${state.selectedDate.getDate()}æ—¥</h3>
               <span class="text-xs text-[#A0A0A0] font-bold">ç´€éŒ„æ‚¨çš„å°±é†«æ­·ç¨‹</span>
             </div>
             <button onclick="closeModal()" class="w-9 h-9 bg-white rounded-full flex items-center justify-center shadow-sm text-slate-400 font-bold">âœ•</button>
          </div>
          <div id="cardsContainer" class="space-y-6 pb-4 overflow-y-auto no-scrollbar"></div>
          <button onclick="closeModal()" class="w-full mt-2 py-4 bg-[var(--main)] text-white rounded-[1.5rem] font-black shadow-lg">å®Œæˆç´€éŒ„</button>
        </div>
      `;
      
      const container = document.getElementById("cardsContainer");
      const renderLimit = Math.min(list.length + 1, 3);
      const getTitle = (idx) => idx === 0 ? "çœ‹é†«ç”Ÿå•¦ï½" : (idx === 1 ? "ä¸€å¤©çœ‹å…©å€‹é†«ç”Ÿå‘€ğŸ¥²" : "çœŸçš„è¾›è‹¦äº†ğŸ¥¹");

      for(let i=0; i<renderLimit; i++){
        const rec = list[i];
        if(!rec){
          if(list.length >= 3) continue;
          const btn = document.createElement("button");
          btn.className = "w-full py-6 rounded-[2rem] bg-white border-2 border-dashed border-[#CFE0B8] flex flex-col items-center gap-2 active:bg-slate-50";
          btn.innerHTML = `<div class="w-10 h-10 rounded-full bg-[#F0F6F0] flex items-center justify-center text-[var(--main)]">ï¼‹</div><span class="text-[var(--main)] font-black text-sm opacity-80">${getTitle(i)}</span>`;
          btn.onclick = () => { if(!state.records[dateKey]) state.records[dateKey] = []; state.records[dateKey].push({hospital:"", doctor:"", item:"", price:"", note:"", rating:null}); saveData(); renderModal(); };
          container.appendChild(btn);
          break;
        }

        const card = document.createElement("div");
        card.className = "p-5 rounded-[2rem] bg-white shadow-sm border border-white space-y-4";
        card.innerHTML = `
           <div class="flex justify-between items-center">
              <span class="bg-[var(--main)] text-white px-3 py-1 rounded-full text-[10px] font-black">NO.${i+1}</span>
              <div class="flex gap-2">
                 <button class="p-2 rounded-xl transition-colors ${rec.rating==='good' ? 'bg-[#E8F3E8] text-[var(--text-green)]' : 'bg-slate-50 text-slate-300'}" onclick="toggleRate(${i}, 'good')">${thumbIcon("currentColor", 16)}</button>
                 <button class="p-2 rounded-xl transition-colors ${rec.rating==='bad' ? 'bg-[#F9EBEB] text-[var(--text-red)]' : 'bg-slate-50 text-slate-300'}" onclick="toggleRate(${i}, 'bad')">${thumbDownIcon("currentColor", 16)}</button>
                 <button class="p-2 rounded-xl bg-slate-50 text-slate-300" onclick="deleteRecord(${i})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
              </div>
           </div>
           <div class="grid grid-cols-2 gap-3">
              <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 pl-1">é†«ç™‚é™¢æ‰€</label><input type="text" class="w-full bg-[#F5F5F3] p-3 rounded-xl text-sm font-black outline-none" value="${rec.hospital||''}" oninput="updateField(${i}, 'hospital', this.value)"></div>
              <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 pl-1">é†«å¸«å§“å</label><input type="text" class="w-full bg-[#F5F5F3] p-3 rounded-xl text-sm font-black outline-none" value="${rec.doctor||''}" oninput="updateField(${i}, 'doctor', this.value)"></div>
              <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 pl-1">çœ‹è¨ºé …ç›®</label><input type="text" class="w-full bg-[#F5F5F3] p-3 rounded-xl text-sm font-black outline-none" value="${rec.item||''}" oninput="updateField(${i}, 'item', this.value)"></div>
              <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 pl-1">æœ¬æ¬¡é‡‘é¡</label><input type="number" inputmode="numeric" class="w-full bg-[#F5F5F3] p-3 rounded-xl text-sm font-black outline-none" value="${rec.price||''}" oninput="updateField(${i}, 'price', this.value)"></div>
           </div>
           <div class="relative">
             <div class="flex justify-between items-center mb-2 px-1">
               <span class="text-[10px] font-bold text-slate-400">å‚™è¨»</span>
               <button onclick="openTagModal(${i})" class="text-[11px] font-bold text-[var(--main)] bg-[#F0F6F0] px-3 py-1 rounded-full">ï¼‹ å¸¸ç”¨æ¨™ç±¤</button>
             </div>
             <textarea id="note-${i}" rows="2" class="w-full bg-[#F5F5F3] p-3 rounded-xl text-xs font-medium outline-none resize-none" oninput="updateField(${i}, 'note', this.value)">${rec.note||''}</textarea>
           </div>
        `;
        container.appendChild(card);
      }
    }

    function openTagModal(idx){
      const overlay = document.createElement("div");
      overlay.id = "tagOverlay";
      overlay.className = "fixed inset-0 z-[110] bg-black/40 backdrop-blur-sm flex items-center justify-center p-6";
      let selectedTags = [];

      const tags = state.tags || [];
      overlay.innerHTML = `
        <div class="bg-white w-full max-w-xs rounded-[2rem] p-5 shadow-2xl animate-pop-in relative">
          <!-- âœ… FIX #3ï¼šç®¡ç†æŒ‰éˆ•ï¼ˆä¿ç•™å–æ¶ˆ/ç¢ºèªï¼‰ -->
          <button onclick="openTagManageModal(${idx})" class="absolute right-4 top-4 text-[11px] font-bold text-[var(--main)] bg-[#F0F6F0] px-3 py-1 rounded-full">ç®¡ç†</button>

          <div class="text-center font-black text-[var(--main-dark)] mb-4">é¸æ“‡å¸¸ç”¨æ¨™ç±¤</div>
          <div class="flex flex-wrap gap-2 justify-center mb-6">
            ${tags.map(tag => `<button data-tag="${tag}" class="tag-btn px-3 py-2 rounded-xl text-xs font-bold border border-slate-200 text-slate-500">${tag}</button>`).join('')}
          </div>
          <div class="flex gap-3">
            <button onclick="document.getElementById('tagOverlay').remove()" class="flex-1 py-3 rounded-xl bg-[#F5F5F3] text-slate-400 font-bold text-sm">å–æ¶ˆ</button>
            <button id="confirmTagBtn" class="flex-1 py-3 rounded-xl bg-[var(--main)] text-white font-bold text-sm">ç¢ºèª</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      overlay.querySelectorAll('.tag-btn').forEach(btn => {
        btn.onclick = () => {
          const t = btn.getAttribute('data-tag');
          if(selectedTags.includes(t)){
            selectedTags = selectedTags.filter(x => x !== t);
            btn.className = "tag-btn px-3 py-2 rounded-xl text-xs font-bold border border-slate-200 text-slate-500";
          } else {
            selectedTags.push(t);
            btn.className = "tag-btn px-3 py-2 rounded-xl text-xs font-bold bg-[var(--main)] text-white border-[var(--main)]";
          }
        };
      });

      document.getElementById('confirmTagBtn').onclick = () => {
        if(selectedTags.length > 0){
          const dateKey = formatDateKey(state.selectedDate);
          const currentNote = state.records[dateKey][idx].note || "";
          const finalNote = currentNote ? `${currentNote} / ${selectedTags.join(" / ")}` : selectedTags.join(" / ");
          state.records[dateKey][idx].note = finalNote;
          saveData();
          const noteEl = document.getElementById(`note-${idx}`);
          if(noteEl) noteEl.value = finalNote;
        }
        overlay.remove();
      };
    }

    /* âœ… FIX #3ï¼šæ¨™ç±¤ç®¡ç† Modalï¼ˆæ–°å¢/åˆªé™¤ + è¨˜æ†¶ï¼‰ */
    function openTagManageModal(returnIdx){
      const modal = document.createElement("div");
      modal.className = "fixed inset-0 z-[115] bg-black/40 backdrop-blur-sm flex items-center justify-center p-6";
      const tags = [...(state.tags || [])];

      function rerender(){
        modal.innerHTML = `
          <div class="bg-white w-full max-w-sm rounded-[2.2rem] p-6 shadow-2xl animate-pop-in">
            <div class="flex items-center justify-between mb-4">
              <div class="font-black text-[var(--main-dark)] text-lg">ç®¡ç†å¸¸ç”¨æ¨™ç±¤</div>
              <button onclick="this.closest('.tag-manage-overlay').remove()" class="w-8 h-8 bg-slate-100 rounded-full text-slate-400 font-bold">âœ•</button>
            </div>

            <div class="flex flex-wrap gap-2 mb-4">
              ${tags.length ? tags.map((t, i)=>`
                <div class="px-3 py-2 rounded-xl bg-[#F9F9F7] border border-white flex items-center gap-2">
                  <span class="text-xs font-bold text-[var(--text)]">${t}</span>
                  <button data-del="${i}" class="w-5 h-5 rounded-full bg-slate-200 text-slate-500 text-[12px] font-black leading-none flex items-center justify-center">Ã—</button>
                </div>
              `).join("") : `<div class="text-slate-300 font-black text-sm">ç›®å‰æ²’æœ‰æ¨™ç±¤</div>`}
            </div>

            <div class="flex gap-2 mb-5">
              <input id="newTagInput" type="text" class="flex-1 bg-[#F5F5F3] p-3 rounded-xl text-sm font-black outline-none" placeholder="æ–°å¢æ¨™ç±¤ï¼ˆä¾‹å¦‚ï¼šè—¥æ•ˆå¿«ï¼‰">
              <button id="addTagBtn" class="px-4 rounded-xl bg-[var(--main)] text-white font-black">æ–°å¢</button>
            </div>

            <button id="closeManageBtn" class="w-full py-3 bg-[#F5F5F3] text-slate-400 rounded-xl font-black">é—œé–‰</button>
          </div>
        `;
        modal.classList.add("tag-manage-overlay");

        modal.querySelectorAll("button[data-del]").forEach(btn=>{
          btn.onclick = () => {
            const idx = Number(btn.getAttribute("data-del"));
            tags.splice(idx, 1);
            saveTags(tags);
            rerender();
          };
        });

        modal.querySelector("#addTagBtn").onclick = () => {
          const inp = modal.querySelector("#newTagInput");
          const val = (inp.value || "").trim();
          if(!val) return;
          if(tags.includes(val)){
            inp.value = "";
            return;
          }
          tags.push(val);
          saveTags(tags);
          inp.value = "";
          rerender();
        };

        modal.querySelector("#closeManageBtn").onclick = () => {
          modal.remove();
          // å›åˆ°åŸæœ¬çš„ tagOverlay è®“å®ƒåƒåˆ°æœ€æ–° tags
          const old = document.getElementById("tagOverlay");
          if(old) old.remove();
          openTagModal(returnIdx);
        };
      }

      rerender();
      document.body.appendChild(modal);
    }

    function openTopModal(){
       const comboMap = {};
       Object.keys(state.records).forEach(key => {
          (state.records[key]||[]).forEach(rec => {
             const h = (rec.hospital||"æœªå¡«é™¢æ‰€").trim();
             const d = (rec.doctor||"æœªå¡«é†«å¸«").trim();
             const i = (rec.item||"ä¸€èˆ¬çœ‹è¨º").trim();
             const k = `${h}||${d}||${i}`;
             comboMap[k] = (comboMap[k]||0)+1;
          });
       });
       const sorted = Object.entries(comboMap).sort((a,b)=>b[1]-a[1]).slice(0, 10);
       const content = sorted.length ? sorted.map(([k, count], i) => {
         const [h, d, it] = k.split("||");
         return `
           <div class="flex items-center justify-between p-3 bg-[#F9F9F7] rounded-xl border border-white">
              <div class="flex items-center gap-3">
                 <div class="w-6 h-6 rounded-full ${i<3?'bg-[var(--main)] text-white':'bg-slate-200 text-slate-400'} flex items-center justify-center text-[10px] font-black shrink-0">${i+1}</div>
                 <div class="overflow-hidden">
                  <div class="text-xs font-black text-[var(--main-dark)] truncate">${h} - ${d}</div>
                  <div class="text-[10px] font-bold text-slate-400 truncate">${it}</div>
                 </div>
              </div>
              <div class="text-xs font-black text-[#D68C8C] shrink-0 ml-2">${count} æ¬¡</div>
           </div>`;
       }).join('') : '<div class="text-center py-8 text-slate-300">å°šç„¡ç´€éŒ„</div>';

       const modal = document.createElement("div");
       modal.className = "fixed inset-0 bg-black/40 backdrop-blur-sm z-[120] flex items-center justify-center p-6";
       modal.innerHTML = `<div class="bg-white w-full max-w-xs rounded-[2.2rem] p-6 shadow-2xl flex flex-col max-h-[70vh]"><div class="text-center font-black text-[var(--main-dark)] mb-4 text-lg">æˆ‘æœ€å¸¸å»</div><div class="flex-1 overflow-y-auto space-y-2 no-scrollbar">${content}</div><button onclick="this.parentElement.parentElement.remove()" class="mt-5 w-full py-3 bg-[var(--main)] text-white rounded-xl font-black">é—œé–‰</button></div>`;
       document.body.appendChild(modal);
    }

    function openListModal(type){
      const stats = calculateStats();
      const data = type === 'good' ? stats.goodData : stats.badData;
      const title = type === 'good' ? "è®šè®šæ¸…å–®" : "è¸©é›·ç´€éŒ„";
      const color = type === 'good' ? "text-[var(--main-dark)]" : "text-[#D68C8C]";

      // âœ… FIX #2ï¼šæ—¥æœŸè¦ä¾æ—¥æœŸæ’åºï¼ˆä¸æ˜¯åŠ å…¥é †åºï¼‰
      const groupMap = new Map();
      data.forEach(item => {
        const hosp = (item.rec.hospital || 'æœªå¡«é™¢æ‰€').trim();
        const doc  = (item.rec.doctor || 'æœªå¡«é†«å¸«').trim();
        const it   = (item.rec.item || 'ä¸€èˆ¬çœ‹è¨º').trim();
        const k = `${hosp}||${doc}`;

        if(!groupMap.has(k)){
          groupMap.set(k, { hospital: hosp, doctor: doc, items: new Set(), dates: new Set() });
        }
        const g = groupMap.get(k);
        g.items.add(it);
        g.dates.add(item.date);
      });

      const displayData = Array.from(groupMap.values()).map(g => {
        const sortedDates = Array.from(g.dates)
          .sort((a,b)=>parseDateKey(a) - parseDateKey(b))
          .map(formatMD);
        return {
          hospital: g.hospital,
          doctor: g.doctor,
          items: Array.from(g.items),
          dates: sortedDates
        };
      });

      const content = displayData.length ? displayData.map(g => `
        <div class="bg-[#F9F9F7] p-4 rounded-2xl border border-white shadow-sm mb-3">
           <div class="flex justify-between items-start mb-1">
             <div class="font-black text-sm text-[var(--text)] truncate mr-2">${g.hospital} - ${g.doctor}</div>
             <div class="text-[10px] font-bold text-slate-300 shrink-0 mt-0.5">${g.dates.join(", ")}</div>
           </div>
           <div class="text-xs font-bold text-[var(--main)] opacity-70 truncate">${g.items.join("ã€")}</div>
        </div>
      `).join('') : '<div class="text-center py-10 text-slate-300 font-black text-sm">ç›®å‰æ²’æœ‰è³‡æ–™</div>';

      const modal = document.createElement("div");
      modal.className = "fixed inset-0 bg-black/40 backdrop-blur-sm z-[120] flex items-center justify-center p-6 list-modal-overlay";
      modal.innerHTML = `
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-6 shadow-2xl max-h-[80vh] flex flex-col">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-black text-lg ${color}">${title}</h3>
            <button onclick="this.closest('.list-modal-overlay').remove()" class="w-8 h-8 bg-slate-100 rounded-full text-slate-400 font-bold">âœ•</button>
          </div>
          <div class="overflow-y-auto no-scrollbar flex-1">${content}</div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function closeModal(){ const m = document.getElementById("editModal"); if(m) m.remove(); render(); }
    function changeMonth(d){ state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth()+d, 1); render(); }
    function goToday(){ state.currentDate = new Date(today.getFullYear(), today.getMonth(), 1); render(); }
    function quickAdd(){ openEditModal(today.getDate()); }
    function toggleRate(i, t){ const k = formatDateKey(state.selectedDate); state.records[k][i].rating = state.records[k][i].rating === t ? null : t; saveData(); renderModal(); }
    function updateField(i, f, v){ const k = formatDateKey(state.selectedDate); state.records[k][i][f] = v; saveData(); }
    function deleteRecord(i){ const k = formatDateKey(state.selectedDate); state.records[k].splice(i,1); if(!state.records[k].length) delete state.records[k]; saveData(); renderModal(); }
    function thumbIcon(c, s=18){ return `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3z"/><path d="M7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>`; }
    function thumbDownIcon(c, s=18){ return `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3z"/><path d="M17 2h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"/></svg>`; }

    render();
  </script>
</body>
</html>